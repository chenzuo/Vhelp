@using VideoHelp.UI.Web
@model VideoHelp.ReadModel.Meeting.MeetingView

@{
    ViewBag.Title = "Комната " + Model.Name;
}


<div style="width: 310px; left: 0; top: 40px; bottom: 0; position: absolute; background: #F9F9F9; border-right: 1px solid #CCC; border-right-width: 1px; border-right-style: solid; border-right-color: #CCCCCC;">
        <div class="container-fluid">
            <div class="page-header">
                            
                <p><a href="#" id="addBox" data-bind="click: createOwnerVideoStream" class="btn btn-success"><i class="icon-facetime-video icon-white"></i>  Включить</a></p>     
            </div>
        </div>
    </div>    
    

<div style="position: absolute;left: 310px; top: 40px; bottom: 0; right: 0; text-align: center; vert-align: middle;">
    
    <div id = "videoSourcesView" class="videoSourcesView" data-bind="template: { name: 'video-preview-template', foreach: videoStreams, afterRender: attachVideoPreview }">  
    </div>
    
    <div id="mainVideoView" class="mainVideo">
    </div>

</div>

<script src="/Scripts/jquery.tmpl.js" type="text/javascript"></script>
<script src="/Scripts/knockout.js" type="text/javascript"></script>
<script src="/Scripts/jquery.signalR.min.js" type="text/javascript"></script>
<script src="/signalr/hubs" type="text/javascript"></script>
<script src="/Scripts/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/Scripts/swfobject.js" type="text/javascript"></script>
<script src="/Scripts/jquery.swfobject.1-1-1.min.js" type="text/javascript"></script>

<script type="text/html" id="video-preview-template">
     <div class="videoPreview" data-userid="${userId}" data-farid="${farId}"/>
</script>

<script type="text/javascript">

    $(function () {
        $('#videoSourcesView').masonry({
            // options
            itemSelector: '.videoPreview',
            isFitWidth: true,
            columnWidth: 100
        });
    });


    var viewModel = {
        videoStreams: ko.observableArray([]),

        createOwnerVideoStream: function () {

            var flash = $.flash.create(
            {
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#000000',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                name: 'video-publisher',
                allowfullscreen: 'true',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'true',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    publish: '@UserManager.CurrentUser',
                    cameraWidth: 640,
                    cameraHeight: 480,
                    cameraQuality: 90,
                    smoothing: true
                }
            });


            addToVideoPreview(flash);
        },

        attachVideoPreview: function (elements) {
            var content = $(elements[0]);

            var userId = content.data('userid');
            var farId = content.data('farid');

            var flash = $.flash.create({
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#000000',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                allowfullscreen: 'false',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'true',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    play: userId,
                    farID: farId
                }
            });

            content.remove();
            addToVideoPreview(flash);
        }
    };

    ko.applyBindings(viewModel);

    function addToVideoPreview(flash) {

        if ($("#mainVideoView").flash().length == 0) {
            $("#mainVideoView").append(flash);
            return;
        }

        var content = $('<div class="videoPreview"/>');
        content.append(flash);

        $('#videoSourcesView').append(content).masonry('appended', content);
        content.append('<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;" class="previewEventDiv"/>');
    }


    $(".previewEventDiv").live("click", function () {
        
        var preview = $(this).parent().flash();
        preview.detach();
        $('#videoSourcesView').masonry('remove', $(this).parent()).masonry('reload');

        fullView = $("#mainVideoView").flash();

        if (fullView.length >= 1) {
            fullView.detach();
            previewBox = $('<div class="videoPreview"/>');
            previewBox.append(fullView);
            $('#videoSourcesView').append(previewBox).masonry('appended', previewBox);
            previewBox.append('<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;" class="previewEventDiv"/>');
        }

        $("#mainVideoView").append(preview);

    });

    var meetingHub = $.connection.meetingHub;

    meetingHub.updateCameraStream = function (userId, farId) {

        if ('@UserManager.CurrentUser' != userId) {
            viewModel.videoStreams.push({ userId: userId, farId: farId }); 
        }
    };

    //стартуем все хабы
    $.connection.hub.start(function () {
        meetingHub.joinToMeeting('@Model.Id', '@UserManager.CurrentUser');
    });

    function onPropertyChange(event) {
        console.log(event.property + " " + event.newValue);
        if (event.property == "nearID" && event.objectID == "video-publisher") {
            meetingHub.attachCameraStream('@Model.Id', '@UserManager.CurrentUser', event.newValue);
        }
    }
 
</script>​