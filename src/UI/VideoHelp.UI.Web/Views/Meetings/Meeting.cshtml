@using VideoHelp.UI.Web
@model VideoHelp.ReadModel.Meeting.MeetingView

@{
    ViewBag.Title = "Комната " + Model.Name;
}


<div style="width: 310px; left: 0; top: 40px; bottom: 0; position: absolute; background: #F9F9F9; border-right: 1px solid #CCC; border-right-width: 1px; border-right-style: solid; border-right-color: #CCCCCC;">
        <div class="container-fluid">
            <div class="page-header">
                            
                <p><a href="#" id="addBox" data-bind="click: createOwnerVideoStream" class="btn btn-success"><i class="icon-facetime-video icon-white"></i> Включить</a></p>     
            </div>
        </div>
    </div>    
    

<div style="position: absolute;left: 310px; top: 40px; bottom: 0; right: 0; text-align: center; vert-align: middle;">
    
    <div class="topContainer">
        <div class="align_center_to_left">
            <div class="videoContainer align_center_to_right">
                <div id="videoView" class="mainVideo" data-bind="showInVideoView: currentStream">
                    <div id="ownerVideoPreview" class="ownerVideoPreview"></div>
                </div>
                <div id ="videoPreviewList" class="videoPreviewListCollapsed"></div>  
            </div>
        </div>
    </div>

    <div id = "videoSourcesView" class="videoSourcesView" data-bind="template: { name: 'video-preview-template', foreach: videoStreams, afterRender: attachVideoPreview }">  
    </div>
    
    <div id="mainVideoView" class="mainVideo">
    </div>

</div>

<script src="/Scripts/jquery.tmpl.js" type="text/javascript"></script>
<script src="/Scripts/knockout.js" type="text/javascript"></script>
<script src="/Scripts/jquery.signalR.min.js" type="text/javascript"></script>
<script src="/signalr/hubs" type="text/javascript"></script>
<script src="/Scripts/swfobject.js" type="text/javascript"></script>
<script src="/Scripts/jquery.swfobject.1-1-1.min.js" type="text/javascript"></script>

<script type="text/html" id="video-preview-template">
     <div class="videoPreview" data-userid="${userId}" data-farid="${farId}"/>
</script>

<script type="text/javascript">

    var viewModel = {
        
        currentStream: ko.observable(),
        videoStreams: ko.observableArray([]),

        createOwnerVideoStream: function () {

            var flash = $.flash.create(
            {
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#3f3f3f',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                name: 'video-publisher',
                allowfullscreen: 'true',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'true',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    publish: '@UserManager.CurrentUser',
                    cameraWidth: 640,
                    cameraHeight: 480,
                    cameraQuality: 90,
                    smoothing: true
                }
            });

            addOwnerSource(flash);
            //addToVideoPreview(flash);
        },

        attachVideoPreview: function (elements) {
            var content = $(elements[0]);

            var userId = content.data('userid');
            var farId = content.data('farid');

            var flash = $.flash.create({
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#3f3f3f',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                allowfullscreen: 'false',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'false',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    play: userId,
                    farID: farId,
                    poster: '@Url.Content("~/Content/img/loading.png")'
                }
            });

            content.remove();
            addToVideoPreview(flash);
        }
        

    };

    ko.bindingHandlers.showInVideoView = {
        update: function (element, valueAccessor) {
            var currentStream = ko.utils.unwrapObservable(valueAccessor());

            if (currentStream == undefined) {
                $("#videoView").flash().remove();
                return;
            }
        }
    };
    
    ko.applyBindings(viewModel);

    function addOwnerSource(flash) {

        if ($("#ownerVideoPreview").flash().length != 0) {
            $("#ownerVideoPreview").children().remove();
        }

        $("#ownerVideoPreview").append(flash).append('<div class="previewEventDiv"/>');
    }

    function addToVideoPreview(flash) {

        if ($("#videoView").flash().length == 0) {
            $("#videoView").append(flash);
            return;
        }
        
        var content = $('<div class="videoPreview"/>');
        content.append(flash);
        content.append('<div class="previewEventDiv"/>');
        $('#videoPreviewList').removeClass('videoPreviewListCollapsed').addClass('videoPreviewList').append(content);

    }

    $("#ownerVideoPreview .previewEventDiv").live("click", function () {
        $('#ownerVideoPreview')
            .toggleClass('ownerVideoPreview')
            .toggleClass('fullScreenOwnerVideoPreview');

        if ($('#ownerVideoPreview').hasClass('fullScreenOwnerVideoPreview')) {
            viewModel.currentStream('dsds');
            viewModel.currentStream(null);
        } else {
            showFromPreview();
        }
    });

    function moveToPreview() {
        var flash = $("#videoView").flash();
        
        if (flash.length != 0) {
            flash.detach();
        }
    }

    $("#videoPreviewList .previewEventDiv").live("click", function () {

        var preview = $(this).parent().flash();
        preview.detach();

        $("#mainVideoView").append(preview);
        
        fullView = $("#mainVideoView").flash();

        if (fullView.length >= 1) {
          //  fullView.detach();
            previewBox = $('<div class="videoPreview"/>');
            previewBox.append(fullView);
            $('#videoSourcesView').append(previewBox).masonry('appended', previewBox);
            previewBox.append('<div style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px;" class="previewEventDiv"/>');
        }

        $('#videoSourcesView').masonry('remove', $(this).parent()).masonry('reload');
        

    });

    var meetingHub = $.connection.meetingHub;

    meetingHub.updateCameraStream = function (userId, farId) {

        if ('@UserManager.CurrentUser' != userId) {
            viewModel.videoStreams.push({ userId: userId, farId: farId }); 
        }
    };

    //стартуем все хабы
    $.connection.hub.start(function () {
        meetingHub.joinToMeeting('@Model.Id', '@UserManager.CurrentUser');
    });

    function onPropertyChange(event) {
        console.log(event.property + " " + event.newValue);
        if (event.property == "nearID" && event.objectID == "video-publisher") {
            meetingHub.attachCameraStream('@Model.Id', '@UserManager.CurrentUser', event.newValue);
        }
    }
 
</script>​