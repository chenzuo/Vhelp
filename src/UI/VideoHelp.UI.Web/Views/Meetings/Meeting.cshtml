@using VideoHelp.UI.Web
@model VideoHelp.ReadModel.Meeting.MeetingView

@{
    ViewBag.Title = "Комната " + Model.Name;
}


<div style="width: 310px; left: 0; top: 40px; bottom: 0; position: absolute; background: #F9F9F9; border-right: 1px solid #CCC; border-right-width: 1px; border-right-style: solid; border-right-color: #CCCCCC;">
        <div class="container-fluid">
            <div class="page-header">
                            
                <p><a href="#" id="addBox" data-bind="click: createOwnerVideoStream" class="btn btn-success"><i class="icon-facetime-video icon-white"></i> Включить</a></p>     
                <p><a href="#" id="process" class="btn btn-success"><i class="icon-facetime-video icon-white"></i> process</a></p>     
            </div>
        </div>
    </div>    
    

<div style="position: absolute;left: 310px; top: 40px; bottom: 0; right: 0; text-align: center; vert-align: middle;">
    
    <div class="topContainer">
        <div class="align_center_to_left">
            <div class="videoContentContainer align_center_to_right">
                <div class="mainVideoContainer">
                    <div id="mainVideoView" class="mainVideo" data-bind="showMainVideoView: currentStream"></div>
                    <div id="ownerVideoPreview" class="ownerVideoPreview"></div>    
                </div>
                <div id ="videoPreviewList" class="videoPreviewListCollapsed" data-bind="foreach: videoStreams">
                    <div id ="preview" class="videoPreview" data-bind = "showVideoPreview: $data"></div>
                </div> 
            </div> 
        </div>
    </div>
</div>

<script src="/Scripts/jquery.tmpl.js" type="text/javascript"></script>
<script src="/Scripts/knockout.js" type="text/javascript"></script>
<script src="/Scripts/jquery.signalR.min.js" type="text/javascript"></script>
<script src="/signalr/hubs" type="text/javascript"></script>
<script src="/Scripts/swfobject.js" type="text/javascript"></script>
<script src="/Scripts/jquery.swfobject.1-1-1.min.js" type="text/javascript"></script>


<script type="text/javascript">

    $viewModel = {
        currentStream: ko.observable(),
        videoStreams: ko.observableArray([]),
        
        addVideoStream: function (userId, farId) {
            var stream = { userId: userId, farId: farId };

            if (this.currentStream() == null) {
                this.currentStream(stream);
                $("#ownerVideoPreview").removeClass('fullScreenOwnerVideoPreview').addClass('ownerVideoPreview');
                return;
            }

            this.videoStreams.push(stream);
        },

        createOwnerVideoStream: function () {

            var flash = $.flash.create(
            {
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#3f3f3f',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                name: 'video-publisher',
                allowfullscreen: 'true',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'true',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    publish: '@UserManager.CurrentUser',
                    cameraWidth: 640,
                    cameraHeight: 480,
                    cameraQuality: 90,
                    smoothing: true
                }
            });

            if ($("#ownerVideoPreview").flash().length != 0) {
                $("#ownerVideoPreview").children().remove();
            }

            $("#ownerVideoPreview").append(flash).append('<div class="previewEventDiv"/>');
            
            if(this.videoStreams().length == 0) {
                $("#ownerVideoPreview").removeClass('ownerVideoPreview').addClass('fullScreenOwnerVideoPreview');
            }
        }
    };

    ko.bindingHandlers.showMainVideoView = {
        update: function (element, valueAccessor) {
            var stream = ko.utils.unwrapObservable(valueAccessor());

            if (stream == undefined) {
                $("#mainVideoView").flash().remove();
                return;
            } 
            else {
                appendFlash($(element), stream.userId, stream.farId);    
            }
        }
    };

    ko.bindingHandlers.showVideoPreview = {
        update: function (element, valueAccessor) {
            var stream = ko.utils.unwrapObservable(valueAccessor());

            $("#videoPreviewList").removeClass('videoPreviewListCollapsed').addClass('videoPreviewList');

            appendFlash($(element), stream.userId, stream.farId);
            $('<div class="previewEventDiv"  data-userid="' + stream.userId + '" data-farid="' + stream.farId + '" />').appendTo($(element));
        }
    };

    ko.applyBindings($viewModel);

    function appendFlash(element, userId, farId) {
        element.flash({
                swf: '@Url.Content("~/Content/flash/VideoIO11.swf")',
                quality: 'high',
                bgcolor: '#3f3f3f',
                width: '100%',
                height: '100%',
                scale: "exactFit",
                allowfullscreen: 'false',
                allowscriptaccess: 'always',
                flashvars: {
                    controls: 'false',
                    url: 'rtmfp://stratus.rtmfp.net/d1e1e5b3f17e90eb35d244fd-c711881365d9',
                    play: userId,
                    farID: farId,
                    poster: '@Url.Content("~/Content/img/loading.png")'
                }
            });

        return element;
    }

    $("#ownerVideoPreview .previewEventDiv").live("click", function () {

        $('#ownerVideoPreview').toggleClass('ownerVideoPreview').toggleClass('fullScreenOwnerVideoPreview');

        if ($('#ownerVideoPreview').hasClass('fullScreenOwnerVideoPreview')) {

            if ($viewModel.currentStream() != null) {
                $viewModel.videoStreams.unshift($viewModel.currentStream());
                $viewModel.currentStream(null);
            }

        } else {
            $viewModel.currentStream($viewModel.videoStreams.shift());
        }
    });


    $("#preview .previewEventDiv").live("click", function () {
        var userId = $(this).data('userid');

        $($viewModel.videoStreams()).each(function (index, stream) {
            if (stream.userId == userId) {
                var removedStream = $viewModel.videoStreams.splice(index, 1)[0];

                if ($viewModel.currentStream() != null) {
                    $viewModel.addVideoStream($viewModel.currentStream().userId, $viewModel.currentStream().farId);
                }

                $viewModel.currentStream(removedStream);
            }
        });

    });


    $('#process').bind('click', function () {
        
        $viewModel.addVideoStream('ewew','453sefrew'); 
    });

    var meetingHub = $.connection.meetingHub;

    meetingHub.updateCameraStream = function (userId, farId) {

        if ('@UserManager.CurrentUser' != userId) {
            $viewModel.addVideoStream(userId, farId); 
        }
    };

    //стартуем все хабы
    $.connection.hub.start(function () {
        meetingHub.joinToMeeting('@Model.Id', '@UserManager.CurrentUser');
    });

    function onPropertyChange(event) {
        console.log(event.property + " " + event.newValue);
        if (event.property == "nearID" && event.objectID == "video-publisher") {
            meetingHub.attachCameraStream('@Model.Id', '@UserManager.CurrentUser', event.newValue);
        }
    }
 
</script>​